---
const projectId = import.meta.env.PUBLIC_COMMENTBOX_PROJECT_ID;
---

<div
	class="commentbox border border-solid p-5 border-gray-200 rounded-2xl max-md:m-[0_20px] relative isolate"
>
</div>

<style>
	/* CommentBox iframe 렌더링 안정화 */
	.commentbox {
		transform: translateZ(0);
		backface-visibility: hidden;
		perspective: 1000px;
		contain: layout style paint;
	}

	/* iframe이 부모 요소의 transform 영향을 받지 않도록 */
	.commentbox iframe {
		transform: translateZ(0) !important;
		backface-visibility: hidden !important;
		will-change: auto !important;
		contain: layout style paint;
	}

	/* 스크롤 시 하얀 화면 방지 */
	.commentbox * {
		transform: translateZ(0);
	}

	/* GPU 가속 활성화 */
	.commentbox {
		-webkit-transform: translateZ(0);
		-moz-transform: translateZ(0);
		-ms-transform: translateZ(0);
		-o-transform: translateZ(0);
		transform: translateZ(0);
	}
</style>

<script src="https://unpkg.com/commentbox.io/dist/commentBox.min.js"></script>
<script define:vars={{ projectId }}>
	let commentBoxInitialized = false;
	let commentBoxInstance = null;
	let scriptLoaded = false;

	// CommentBox 초기화 함수
	function initializeCommentBox() {
		if (!commentBoxInitialized && typeof commentBox === 'function') {
			try {
				commentBoxInstance = commentBox(projectId);
				commentBoxInitialized = true;
				console.log('CommentBox initialized successfully');

				// 초기화 후 iframe 안정화
				setTimeout(() => {
					stabilizeIframes();
				}, 500);
			} catch (error) {
				console.error('CommentBox initialization failed:', error);
			}
		}
	}

	// iframe 안정화 함수
	function stabilizeIframes() {
		const iframes = document.querySelectorAll('.commentbox iframe');
		iframes.forEach((iframe) => {
			iframe.style.transform = 'translateZ(0)';
			iframe.style.backfaceVisibility = 'hidden';
			iframe.style.willChange = 'auto';
			iframe.style.position = 'relative';
			iframe.style.zIndex = '1';
		});
	}

	// Intersection Observer를 사용한 지연 로딩
	const observerOptions = {
		root: null,
		rootMargin: '50px',
		threshold: 0.1
	};

	const commentBoxObserver = new IntersectionObserver((entries) => {
		entries.forEach((entry) => {
			if (entry.isIntersecting && !commentBoxInitialized) {
				// 뷰포트에 들어왔을 때만 초기화
				setTimeout(() => {
					initializeCommentBox();
				}, 100);
				commentBoxObserver.unobserve(entry.target);
			}
		});
	}, observerOptions);

	// DOM 로드 시 observer 시작
	if (document.readyState === 'loading') {
		window.addEventListener('DOMContentLoaded', () => {
			const commentBoxElement = document.querySelector('.commentbox');
			if (commentBoxElement) {
				commentBoxObserver.observe(commentBoxElement);
			}
		});
	} else {
		const commentBoxElement = document.querySelector('.commentbox');
		if (commentBoxElement) {
			commentBoxObserver.observe(commentBoxElement);
		}
	}

	// 스크롤 이벤트 최적화 및 iframe 안정화
	let scrollTimeout;
	let lastScrollTop = 0;

	window.addEventListener(
		'scroll',
		() => {
			clearTimeout(scrollTimeout);

			scrollTimeout = setTimeout(() => {
				const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

				// 스크롤 방향 감지
				const isScrollingDown = currentScrollTop > lastScrollTop;
				lastScrollTop = currentScrollTop;

				// iframe 안정화
				const iframes = document.querySelectorAll('.commentbox iframe');
				iframes.forEach((iframe) => {
					// iframe이 보이는 상태에서만 처리
					const rect = iframe.getBoundingClientRect();
					const isVisible = rect.top < window.innerHeight && rect.bottom > 0;

					if (isVisible) {
						// GPU 가속 강제 적용
						iframe.style.transform = 'translateZ(0)';
						iframe.style.backfaceVisibility = 'hidden';
						iframe.style.willChange = 'auto';

						// 부모 요소의 transform 영향 차단
						iframe.style.position = 'relative';
						iframe.style.zIndex = '1';
					}
				});
			}, 50);
		},
		{ passive: true }
	);

	// 페이지 가시성 변경 시 iframe 안정화
	document.addEventListener('visibilitychange', () => {
		if (!document.hidden) {
			setTimeout(() => {
				stabilizeIframes();
			}, 100);
		}
	});

	// 윈도우 리사이즈 시 iframe 안정화
	window.addEventListener('resize', () => {
		setTimeout(() => {
			stabilizeIframes();
		}, 100);
	});
</script>
